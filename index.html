<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iran Political Map 2025</title>
    
    <!-- Leaflet & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. GLOBAL CORE --- */
        body, html { height: 100%; margin: 0; background-color: #050505; font-family: 'Inter', sans-serif; overflow: hidden; user-select: none; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #050505; outline: none; }
        path.leaflet-interactive:focus { outline: none; }

        /* --- 2. GLASS HEADER --- */
        .glass-header {
            position: absolute; top: 20px; left: 20px; z-index: 1000; width: 320px;
            padding: 24px; background: rgba(10, 15, 10, 0.65);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 255, 200, 0.1); border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
            color: white; pointer-events: none; transition: all 0.3s ease;
        }
        .glass-header h1 { margin: 0; font-size: 24px; font-weight: 800; color: #e0f7fa; letter-spacing: -0.5px; }
        .glass-header p { margin: 6px 0 0 0; font-size: 12px; color: #4db6ac; font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 1.5px; }

        /* --- 3. RESPONSIVE SIDEBAR --- */
        .info-sidebar {
            position: absolute; z-index: 2000; /* Top layer */
            background: rgba(12, 16, 15, 0.95);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(0, 255, 200, 0.1);
            padding: 30px; color: white; display: flex; flex-direction: column;
            box-shadow: 0 0 80px rgba(0,0,0,0.9);
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            overflow-y: auto;
        }
        .drag-handle {
            width: 40px; height: 5px; background: rgba(0, 255, 200, 0.2);
            border-radius: 10px; margin: -10px auto 20px auto; display: none;
        }

        /* Desktop (Right Side, 30-40% Width) */
        @media (min-width: 769px) {
            .info-sidebar { 
                top: 20px; right: -500px; bottom: 20px; width: 380px; 
                border-radius: 24px 0 0 24px; border-right: none;
            }
            .info-sidebar.active { right: 0; transform: translateX(0); }
        }

        /* Mobile (Bottom Sheet) */
        @media (max-width: 768px) {
            .glass-header { top: 10px; left: 10px; width: calc(100% - 60px); padding: 15px; }
            
            .info-sidebar { 
                left: 0; right: 0; bottom: 0; 
                height: 45%; 
                width: auto; 
                border-radius: 24px 24px 0 0; 
                border-bottom: none; border-left: none; border-right: none;
                transform: translateY(100%); /* Start hidden below */
                padding: 20px;
            }
            
            .info-sidebar.active { 
                transform: translateY(0); /* Slide up */
            }
            .drag-handle { display: block; }
        }

        /* --- 4. STYLING & BADGES --- */
        .badge-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .pol-badge { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 50px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-family: 'Inter', sans-serif; }
        
        /* Faction Colors */
        .badge-prin { background: rgba(0, 200, 255, 0.15); color: #00ccff; border: 1px solid rgba(0, 200, 255, 0.4); box-shadow: 0 0 15px rgba(0, 200, 255, 0.2); } /* Principlist (Blue) */
        .badge-ref { background: rgba(0, 255, 100, 0.15); color: #00ff66; border: 1px solid rgba(0, 255, 100, 0.4); box-shadow: 0 0 15px rgba(0, 255, 100, 0.2); } /* Reformist (Green) */
        .badge-ind { background: rgba(255, 200, 50, 0.15); color: #ffcc33; border: 1px solid rgba(255, 200, 50, 0.4); box-shadow: 0 0 15px rgba(255, 200, 50, 0.2); } /* Independent (Yellow) */

        .sidebar-title { font-size: 32px; font-weight: 700; margin: 0 0 10px 0; line-height: 1.1; color: #ffffff; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;}
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .data-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .data-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: #888; margin-bottom: 6px; font-weight: 700; }
        .data-value { font-size: 14px; font-weight: 600; color: #eee; line-height: 1.4; }
        
        /* Seat Count Bar */
        .seat-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 10px; overflow: hidden; display: flex; }
        .seat-segment { height: 100%; }
        
        /* Tooltip */
        .leaflet-tooltip.glass-tooltip {
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 200, 0.2); border-radius: 8px; color: #fff;
            font-family: 'Inter', sans-serif; font-weight: 700; font-size: 11px; letter-spacing: 0.5px;
            text-transform: uppercase; box-shadow: 0 10px 30px rgba(0,0,0,0.5); padding: 6px 12px;
        }
        .leaflet-tooltip-top:before, .leaflet-tooltip-bottom:before, .leaflet-tooltip-left:before, .leaflet-tooltip-right:before { display: none; }

    </style>
</head>
<body>

    <div class="glass-header">
        <h1>Iran Governance</h1>
        <p>Political Landscape 2025</p>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="info-sidebar">
        <div class="drag-handle"></div> 
        <div id="sidebar-content">
            <p style="color:#666; text-align:center; margin-top:20px;">Select a province to view details</p>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. SETUP MAP ---
        var map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            center: [32.4279, 53.6880], 
            zoom: 5,
            zoomSnap: 0.5,
            zoomDelta: 0.5
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        var selectedLayer = null;

        // --- 2. HASC CODE & NAME MATCHING ---
        function normalizeName(feature) {
            // First check HASC codes (most reliable, usually in properties like HASC_1 or code_hasc)
            // Codes based on ISO 3166-2:IR or similar standards seen in map data
            const code = feature.properties.HASC_1 || feature.properties.code_hasc || feature.properties.iso_3166_2 || "";
            
            if (code) {
                const codeMap = {
                    "IR.AL": "Alborz",
                    "IR.AR": "Ardabil",
                    "IR.AG": "West Azerbaijan", "IR.WA": "West Azerbaijan",
                    "IR.EA": "East Azerbaijan", "IR.ES": "East Azerbaijan",
                    "IR.BU": "Bushehr", "IR.BS": "Bushehr",
                    "IR.CM": "Chaharmahal and Bakhtiari", "IR.CB": "Chaharmahal and Bakhtiari",
                    "IR.FA": "Fars",
                    "IR.GI": "Gilan",
                    "IR.GO": "Golestan",
                    "IR.HA": "Hamadan",
                    "IR.HO": "Hormozgan", "IR.HG": "Hormozgan",
                    "IR.IL": "Ilam",
                    "IR.IS": "Isfahan", "IR.ES": "Isfahan",
                    "IR.KE": "Kerman",
                    "IR.BK": "Kermanshah", "IR.KS": "Kermanshah",
                    "IR.KZ": "Khuzestan", "IR.KH": "Khuzestan",
                    "IR.KB": "Kohgiluyeh and Boyer-Ahmad",
                    "IR.KD": "Kurdistan",
                    "IR.LO": "Lorestan",
                    "IR.MA": "Markazi", "IR.MK": "Markazi",
                    "IR.MN": "Mazandaran", "IR.MZ": "Mazandaran",
                    "IR.NK": "North Khorasan",
                    "IR.QM": "Qom",
                    "IR.RK": "Razavi Khorasan",
                    "IR.SE": "Semnan",
                    "IR.SB": "Sistan and Baluchestan",
                    "IR.SK": "South Khorasan",
                    "IR.TH": "Tehran", "IR.TE": "Tehran",
                    "IR.YA": "Yazd",
                    "IR.ZA": "Zanjan"
                };
                if (codeMap[code]) return codeMap[code];
            }

            // Fallback to name matching
            let name = feature.properties.NAME_1 || 
                       feature.properties.name_1 || 
                       feature.properties.name_en || 
                       feature.properties.name || 
                       feature.properties.NAME || 
                       feature.properties.Name || 
                       feature.properties.shapeName || 
                       feature.properties.enname ||
                       "";
                       
            if (!name) return "";
            let n = name.trim().toLowerCase();
            
            const map = {
                // English variations
                "esfahan": "Isfahan", "isfahan": "Isfahan",
                "teheran": "Tehran", "tehran": "Tehran",
                "baluchistan": "Sistan and Baluchestan", "sistan and baluchestan": "Sistan and Baluchestan", "sistan & baluchestan": "Sistan and Baluchestan", "sistan_and_baluchestan": "Sistan and Baluchestan",
                "chahar mahaal and bakhtiari": "Chaharmahal and Bakhtiari", "chaharmahal and bakhtiari": "Chaharmahal and Bakhtiari", "chahar mahall & bakhtiari": "Chaharmahal and Bakhtiari",
                "kohgiluyeh and boyer-ahmad": "Kohgiluyeh and Boyer-Ahmad", "kohgiluyeh and boyer ahmad": "Kohgiluyeh and Boyer-Ahmad", "kohgiluyeh & boyer-ahmad": "Kohgiluyeh and Boyer-Ahmad",
                "razavi khorasan": "Razavi Khorasan", "khorasan razavi": "Razavi Khorasan", "khorasan-e razavi": "Razavi Khorasan",
                "south khorasan": "South Khorasan", "khorasan south": "South Khorasan", "khorasan-e jonubi": "South Khorasan",
                "north khorasan": "North Khorasan", "khorasan north": "North Khorasan", "khorasan-e shomali": "North Khorasan",
                "east azerbaijan": "East Azerbaijan", "east azarbayjan": "East Azerbaijan", "azarbayjan-e sharqi": "East Azerbaijan",
                "west azerbaijan": "West Azerbaijan", "west azarbayjan": "West Azerbaijan", "azarbayjan-e gharbi": "West Azerbaijan",
                "markazi": "Markazi", "central": "Markazi",
                "mazandaran": "Mazandaran",
                "gilan": "Gilan",
                "golestan": "Golestan",
                "ardabil": "Ardabil", "ardebil": "Ardabil",
                "zanjan": "Zanjan",
                "qazvin": "Qazvin",
                "qom": "Qom",
                "semnan": "Semnan",
                "yazd": "Yazd",
                "fars": "Fars",
                "bushehr": "Bushehr",
                "hormozgan": "Hormozgan",
                "kerman": "Kerman",
                "khuzestan": "Khuzestan",
                "lorestan": "Lorestan",
                "ilam": "Ilam",
                "kermanshah": "Kermanshah", "kermanshah province": "Kermanshah",
                "kurdistan": "Kurdistan", "kordestan": "Kurdistan",
                "hamadan": "Hamadan", "hamedan": "Hamadan",
                "alborz": "Alborz",
                
                // Farsi variations (from your screenshot)
                "تهران": "Tehran",
                "اصفهان": "Isfahan",
                "فارس": "Fars",
                "خراسان رضوی": "Razavi Khorasan",
                "آذربایجان شرقی": "East Azerbaijan",
                "خوزستان": "Khuzestan",
                "مازندران": "Mazandaran",
                "آذربایجان غربی": "West Azerbaijan",
                "کرمان": "Kerman",
                "گیلان": "Gilan",
                "سیستان و بلوچستان": "Sistan and Baluchestan",
                "کرمانشاه": "Kermanshah",
                "لرستان": "Lorestan",
                "همدان": "Hamadan",
                "گلستان": "Golestan",
                "کردستان": "Kurdistan",
                "هرمزگان": "Hormozgan",
                "اردبیل": "Ardabil",
                "مرکزی": "Markazi",
                "قم": "Qom",
                "یزد": "Yazd",
                "بوشهر": "Bushehr",
                "زنجان": "Zanjan",
                "قزوین": "Qazvin",
                "سمنان": "Semnan",
                "خراسان شمالی": "North Khorasan",
                "خراسان جنوبی": "South Khorasan",
                "ایلام": "Ilam",
                "کهگیلویه و بویراحمد": "Kohgiluyeh and Boyer-Ahmad",
                "چهارمحال و بختیاری": "Chaharmahal and Bakhtiari",
                "البرز": "Alborz"
            };
            
            if (map[n]) return map[n];
            return name.charAt(0).toUpperCase() + name.slice(1);
        }

        // --- 3. POLITICAL DATA (2025) ---
        // P = Principlist, R = Reformist, I = Independent
        const provinceData = {
            "Tehran": { code: "P", seats: 35, split: {p: 28, r: 2, i: 5}, gov: "Principlist Dominant", leader: "Tehran Governor" },
            "Isfahan": { code: "P", seats: 20, split: {p: 16, r: 1, i: 3}, gov: "Conservative Stronghold", leader: "Isfahan Governor" },
            "Fars": { code: "P", seats: 18, split: {p: 14, r: 2, i: 2}, gov: "Conservative Leaning", leader: "Fars Governor" },
            "Razavi Khorasan": { code: "P", seats: 18, split: {p: 15, r: 1, i: 2}, gov: "Hardline Conservative", leader: "Mashhad Governor" },
            "East Azerbaijan": { code: "R", seats: 19, split: {p: 7, r: 10, i: 2}, gov: "Reformist Leaning", leader: "Tabriz Governor" },
            "Khuzestan": { code: "I", seats: 18, split: {p: 6, r: 5, i: 7}, gov: "Mixed / Independent", leader: "Ahvaz Governor" },
            "Mazandaran": { code: "I", seats: 12, split: {p: 5, r: 5, i: 2}, gov: "Moderate / Mixed", leader: "Sari Governor" },
            "West Azerbaijan": { code: "I", seats: 12, split: {p: 4, r: 3, i: 5}, gov: "Ethnic Coalition", leader: "Urmia Governor" },
            "Kerman": { code: "P", seats: 10, split: {p: 8, r: 1, i: 1}, gov: "Conservative", leader: "Kerman Governor" },
            "Gilan": { code: "I", seats: 13, split: {p: 5, r: 5, i: 3}, gov: "Reformist/Ind. Stronghold", leader: "Rasht Governor" },
            "Sistan and Baluchestan": { code: "I", seats: 8, split: {p: 1, r: 3, i: 4}, gov: "Sunni Independent", leader: "Zahedan Governor" },
            "Kermanshah": { code: "I", seats: 8, split: {p: 3, r: 2, i: 3}, gov: "Mixed", leader: "Kermanshah Governor" },
            "Lorestan": { code: "P", seats: 9, split: {p: 6, r: 2, i: 1}, gov: "Conservative", leader: "Khorramabad Governor" },
            "Hamadan": { code: "P", seats: 9, split: {p: 7, r: 1, i: 1}, gov: "Conservative", leader: "Hamadan Governor" },
            "Golestan": { code: "R", seats: 7, split: {p: 2, r: 4, i: 1}, gov: "Reformist Leaning", leader: "Gorgan Governor" },
            "Kurdistan": { code: "R", seats: 6, split: {p: 1, r: 4, i: 1}, gov: "Reformist / Kurdish", leader: "Sanandaj Governor" },
            "Hormozgan": { code: "I", seats: 5, split: {p: 2, r: 1, i: 2}, gov: "Independent Commercial", leader: "Bandar Abbas Governor" },
            "Ardabil": { code: "P", seats: 7, split: {p: 5, r: 1, i: 1}, gov: "Conservative", leader: "Ardabil Governor" },
            "Markazi": { code: "P", seats: 7, split: {p: 5, r: 1, i: 1}, gov: "Industrial Conservative", leader: "Arak Governor" },
            "Qom": { code: "P", seats: 3, split: {p: 3, r: 0, i: 0}, gov: "Religious Hardline", leader: "Qom Governor" },
            "Yazd": { code: "R", seats: 4, split: {p: 1, r: 3, i: 0}, gov: "Reformist Cultural", leader: "Yazd Governor" },
            "Bushehr": { code: "P", seats: 4, split: {p: 3, r: 1, i: 0}, gov: "Conservative", leader: "Bushehr Governor" },
            "Zanjan": { code: "P", seats: 5, split: {p: 4, r: 1, i: 0}, gov: "Conservative", leader: "Zanjan Governor" },
            "Qazvin": { code: "P", seats: 4, split: {p: 3, r: 1, i: 0}, gov: "Conservative", leader: "Qazvin Governor" },
            "Semnan": { code: "P", seats: 4, split: {p: 3, r: 0, i: 1}, gov: "Conservative", leader: "Semnan Governor" },
            "North Khorasan": { code: "P", seats: 4, split: {p: 3, r: 1, i: 0}, gov: "Conservative", leader: "Bojnord Governor" },
            "South Khorasan": { code: "P", seats: 4, split: {p: 4, r: 0, i: 0}, gov: "Hardline Conservative", leader: "Birjand Governor" },
            "Ilam": { code: "I", seats: 3, split: {p: 1, r: 1, i: 1}, gov: "Tribal Independent", leader: "Ilam Governor" },
            "Kohgiluyeh and Boyer-Ahmad": { code: "P", seats: 3, split: {p: 2, r: 0, i: 1}, gov: "Conservative", leader: "Yasuj Governor" },
            "Chaharmahal and Bakhtiari": { code: "I", seats: 4, split: {p: 1, r: 1, i: 2}, gov: "Tribal Independent", leader: "Shahr-e Kord Governor" },
            "Alborz": { code: "P", seats: 3, split: {p: 2, r: 1, i: 0}, gov: "Conservative", leader: "Karaj Governor" }
        };

        // --- 5. STYLING ---
        function getColor(code) {
            if(code === 'P') return '#00ccff'; // Principlist (Blue/Cyan)
            if(code === 'R') return '#00ff66'; // Reformist (Green)
            if(code === 'I') return '#ffcc33'; // Independent (Yellow)
            return '#333';
        }

        function style(feature) {
            let normalized = normalizeName(feature);
            
            const data = provinceData[normalized];
            const color = data ? getColor(data.code) : '#2a2a2a'; // Dark grey if no data found
            
            return {
                fillColor: color,
                weight: 1,
                opacity: 1,
                color: '#444', 
                fillOpacity: data ? 0.35 : 0.1
            };
        }

        // --- 6. INTERACTION ---
        function highlightFeature(e) {
            var layer = e.target;
            if (layer !== selectedLayer) {
                layer.setStyle({ weight: 2, color: '#fff', fillOpacity: 0.6 });
                layer.bringToFront();
            }
        }

        function resetHighlight(e) {
            var layer = e.target;
            if (layer !== selectedLayer) {
                geojson.resetStyle(layer);
            }
        }

        function zoomToFeature(e) {
            L.DomEvent.stopPropagation(e);
            var layer = e.target;
            
            let normalized = normalizeName(layer.feature);

            if (selectedLayer && selectedLayer !== layer) geojson.resetStyle(selectedLayer);
            selectedLayer = layer;
            selectedLayer.setStyle({ weight: 3, color: '#00ffc8', fillOpacity: 0.7 });
            selectedLayer.bringToFront();

            const isMobile = window.innerWidth <= 768;
            const paddingOptions = isMobile 
                ? { paddingBottomRight: [0, window.innerHeight * 0.35] } 
                : { paddingBottomRight: [400, 0], paddingTopLeft: [50, 50] };

            map.fitBounds(layer.getBounds(), { ...paddingOptions, maxZoom: 7, duration: 1.2 });

            updateSidebar(normalized, layer.feature.properties);
            
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('active');
            if(isMobile) sidebar.style.transform = 'translateY(0)';
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
            
            let normalized = normalizeName(feature);
            if (normalized) layer.bindTooltip(normalized, { permanent: false, direction: "center", className: "glass-tooltip" });
        }

        function updateSidebar(name, properties) {
            const data = provinceData[name];
            
            if (!data) {
                // FALLBACK: Dump all properties so we can see what went wrong
                const debugProps = Object.keys(properties).map(key => `<b>${key}:</b> ${properties[key]}`).join('<br>');
                
                document.getElementById('sidebar-content').innerHTML = `
                    <h2 class="sidebar-title">${name || "Unknown"}</h2>
                    <p style="color:#ff5555; margin-bottom:15px;">Data mismatch detected.</p>
                    <div style="background:rgba(0,0,0,0.5); padding:10px; border-radius:8px; font-family:monospace; font-size:10px; color:#aaa; overflow-wrap:break-word;">
                        ${debugProps}
                    </div>
                    <p style="color:#666; font-size:10px; margin-top:10px;">The system couldn't match this region's name to the database. Use the properties above to update the code.</p>
                `;
                return;
            }
            
            let badgeClass = 'badge-prin';
            let typeText = 'Principlist';
            if(data.code === 'R') { badgeClass = 'badge-ref'; typeText = 'Reformist'; }
            if(data.code === 'I') { badgeClass = 'badge-ind'; typeText = 'Independent'; }

            const pW = (data.split.p / data.seats) * 100;
            const rW = (data.split.r / data.seats) * 100;
            const iW = (data.split.i / data.seats) * 100;

            const html = `
                <div class="badge-container"><span class="pol-badge ${badgeClass}">${typeText}</span></div>
                <h2 class="sidebar-title">${name}</h2>
                
                <div class="data-grid">
                    <div class="data-item"><div class="data-label">Total Seats</div><div class="data-value">${data.seats}</div></div>
                    <div class="data-item"><div class="data-label">Political Lean</div><div class="data-value">${data.gov}</div></div>
                    <div class="data-item"><div class="data-label">Leadership</div><div class="data-value">${data.leader}</div></div>
                    <div class="data-item"><div class="data-label">Election Cycle</div><div class="data-value">2024 - 2028</div></div>
                </div>

                <div class="data-item">
                    <div class="data-label" style="margin-bottom:10px;">Majles Seat Distribution</div>
                    <div class="seat-bar-bg">
                        <div class="seat-segment" style="width:${pW}%; background:#00ccff;"></div>
                        <div class="seat-segment" style="width:${rW}%; background:#00ff66;"></div>
                        <div class="seat-segment" style="width:${iW}%; background:#ffcc33;"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:10px; color:#aaa;">
                        <span style="color:#00ccff">Prin: ${data.split.p}</span>
                        <span style="color:#00ff66">Ref: ${data.split.r}</span>
                        <span style="color:#ffcc33">Ind: ${data.split.i}</span>
                    </div>
                </div>
            `;
            document.getElementById('sidebar-content').innerHTML = html;
        }

        // --- 7. SWIPE LOGIC (MOBILE) ---
        const sidebar = document.getElementById('sidebar');
        let startY = 0, currentY = 0, isDragging = false;
        
        sidebar.addEventListener('touchstart', (e) => { if(sidebar.classList.contains('active')) { startY = e.touches[0].clientY; isDragging = true; sidebar.style.transition = 'none'; } }, {passive:true});
        sidebar.addEventListener('touchmove', (e) => { if(isDragging) { currentY = e.touches[0].clientY; const delta = currentY - startY; if(delta > 0) sidebar.style.transform = `translateY(${delta}px)`; } }, {passive:true});
        sidebar.addEventListener('touchend', () => { 
            if(isDragging) { 
                isDragging = false; 
                sidebar.style.transition = 'transform 0.3s cubic-bezier(0.22, 1, 0.36, 1)'; 
                if((currentY - startY) > 80) closeSidebar(); else sidebar.style.transform = 'translateY(0)'; 
            } 
        });

        function closeSidebar() {
            sidebar.classList.remove('active');
            if (window.innerWidth <= 768) sidebar.style.transform = 'translateY(100%)';
            if (selectedLayer) { selectedLayer.setStyle({ fillOpacity: 0.35, weight: 1, color: '#444' }); selectedLayer = null; }
            map.flyTo([32.4279, 53.6880], 5);
        }

        map.on('click', (e) => { if(e.originalEvent.target.id === 'map') closeSidebar(); });

        // --- 8. LOAD GEOJSON ---
        // Robust loader with backup sources
        const sources = [
            'https://raw.githubusercontent.com/mrunderline/iran-geojson/master/iran_geo.json', // Source with NAME_1 and HASC_1 (based on your screenshot)
            'https://raw.githubusercontent.com/codeforamerica/click_that_hood/main/public/data/iran.geojson'
        ];

        function loadData(index) {
            if (index >= sources.length) {
                document.getElementById('sidebar-content').innerHTML = `
                    <h2 class="sidebar-title">Connection Error</h2>
                    <p style="color:#ff5555;">Failed to load map data from all sources.</p>
                `;
                return;
            }

            fetch(sources[index])
                .then(res => {
                    const contentType = res.headers.get("content-type");
                    if (!res.ok || (contentType && contentType.indexOf("application/json") === -1 && contentType.indexOf("text/plain") === -1)) {
                         if (contentType && contentType.includes("text/html")) throw new Error("Received HTML instead of JSON");
                    }
                    return res.json();
                })
                .then(data => {
                    geojson = L.geoJson(data, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                })
                .catch(err => {
                    console.warn(`Source ${index} failed:`, err);
                    loadData(index + 1); // Try next source
                });
        }
        
        loadData(0);

    </script>
</body>
</html>
